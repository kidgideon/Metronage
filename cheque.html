<!-- Complete vanilla CSS Cheque Management Page -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cheque Management - Metronagex Bank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@iconscout/unicons@4.0.8/css/line.min.css">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon.ico">

  <link rel="stylesheet" href="./styles/index.css">
  <style>
    :root {
      --primary-color: black;
      --primary-dark: black;
      --primary-light: #d4edda;
      --secondary-color: #6c757d;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: black;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --white: #ffffff;
      --border-radius: 8px;
      --box-shadow: 0 2px 24px 0 rgba(80,80,120,0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
 
     body {
      background-color: black;
     }
    .heart-icon {
      color: var(--danger-color);
    }

    /* Main content */
    main {
      padding-top: 50px;
      margin-left: 0;
      transition: var(--transition);
      padding: 20px;
      width: 100%;
    }

     
.userChequeHistory {
   display: flex;
   justify-content: center;
   align-items: center;
  width: 100%;
  text-align: center;
}

    /* Tabs */
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      border-bottom: 1px solid #ddd;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: none;
      border: none;
      font-family: 'Jost', sans-serif;
      font-weight: 600;
      color: var(--secondary-color);
      position: relative;
      transition: var(--transition);
    }

    .tab.active {
      color: var(rgb(96, 96, 96)  );
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--primary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Form styles */
    .form-section {
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 30px;
      margin-bottom: 30px;
      max-width: 600px;
      margin: 0 auto 30px;
    }

    .form-section h4 {
      margin-bottom: 20px;
      color: var(--primary-color);
      font-size: 1.5rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--secondary-color);
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-family: 'Jost', sans-serif;
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
    }

    .form-select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-family: 'Jost', sans-serif;
      font-size: 1rem;
      background-color: var(--white);
      transition: var(--transition);
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
    }

    /* Button styles */
    .btn {
      display: inline-block;
      padding: 12px 24px;
      font-family: 'Jost', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      text-align: center;
      text-decoration: none;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: var(--white);
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
    }

    .btn-success {
      background-color: var(--primary-color);
      color: var(--white);
    }

    .btn-success:hover {
      background-color: var(--primary-dark);
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    /* Alert styles */
    .alert {
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
    }

    .alert-success {
      background-color: var(--primary-light);
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    .alert-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      width: 50%;
    }

    /* Cheque card styles */
    .cheque-card {
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 30px;
      margin: 30px auto;
      max-width: 600px;
      font-family: 'Jost', sans-serif;
      border: 2px solid var(--primary-color);
      position: relative;
    }

    .cheque-header {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 20px;
      letter-spacing: 2px;
      text-align: center;
      text-transform: uppercase;
    }

    .cheque-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px 30px;
      margin-bottom: 25px;
    }

    .cheque-field-label {
      font-weight: 500;
      color: var(--secondary-color);
      font-size: 0.95rem;
    }

    .cheque-field-value {
      font-weight: 600;
      color: var(--dark-color);
      font-size: 1.1rem;
      word-break: break-all;
    }

    .cheque-status {
      position: absolute;
      top: 25px;
      right: 30px;
      font-size: 0.9rem;
      font-weight: 700;
      padding: 5px 15px;
      border-radius: 20px;
      background: var(--light-color);
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      text-transform: capitalize;
    }

    .cheque-status.processing {
      background: #fff3cd;
      color: #856404;
      border-color: #ffeeba;
    }

    .cheque-status.completed {
      background: var(--primary-light);
      color: #155724;
      border-color: #c3e6cb;
    }

    .cheque-status.rejected {
      background: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }

    .cheque-footer {
      text-align: right;
      font-size: 0.95rem;
      color: var(--secondary-color);
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px dashed #ddd;
    }

    .signature-line {
      display: inline-block;
      margin-left: 10px;
      border-bottom: 1px solid #333;
      width: 150px;
      position: relative;
    }

    .signature-text {
      position: absolute;
      bottom: -20px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 0.8rem;
    }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }

   
    /* Responsive styles */
    @media (max-width: 768px) {
      .cheque-fields {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .cheque-status {
        position: static;
        display: inline-block;
        margin-bottom: 15px;
      }

      .tabs {
        flex-wrap: wrap;
      }

      .tab {
        padding: 8px 15px;
        font-size: 0.9rem;
      }
       
      main {
        padding-top: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    /* Activation Required Modal Styles */
#activationRequiredModal {
  position: fixed;
  z-index: 99999;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.45);
}
#activationRequiredModal.show {
  display: flex;
}
#activationRequiredModal .modal-dialog {
  margin: 0;
  max-width: 400px;
  width: 90vw;
  display: flex;
  align-items: center;
  justify-content: center;
}
#activationRequiredModal .modal-content {
  background: #fff;
  color: #000;
  border-radius: 1rem;
  box-shadow: 0 2px 24px #0002;
  padding: 0;
}
#activationRequiredModal .modal-header {
  background: #ffcdd2;
  border-bottom: 1px solid #f5c6cb;
  border-top-left-radius: 1rem;
  border-top-right-radius: 1rem;
  color: #000;
}
#activationRequiredModal .modal-title {
  color: #000;
  font-weight: 700;
}
#activationRequiredModal .modal-body {
  color: #000;
  padding: 1.5rem 1.5rem 1rem 1.5rem;
  font-size: 1.1rem;
}
#activationRequiredModal .modal-footer {
  border-top: 1px solid #f5c6cb;
  border-bottom-right-radius: 1rem;
  border-bottom-left-radius: 1rem;
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: flex-end;
}
#activationRequiredModal .btn-danger {
  background: #dc3545;
  border: none;
  color: #fff;
  border-radius: 0.5rem;
  padding: 0.5rem 1.5rem;
  font-weight: 600;
}
#activationRequiredModal .btn-close {
  background: transparent;
  border: none;
  font-size: 1.5rem;
  color: #000;
  opacity: 0.5;
  margin-left: auto;
}
#activationRequiredModal .btn-close:hover {
  opacity: 0.8;
}

/* Activation Modal Overlay and Centered Modal */
#activationModalOverlay {
  position: fixed;
  z-index: 99999;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.45);
  display: none;
}
#activationModalOverlay.show {
  display: flex;
}
.activation-modal-centered {
  width: 100vw; height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}
.activation-modal-content {
  background: #fff;
  color: #000;
  border-radius: 1rem;
  box-shadow: 0 2px 24px #0002;
  max-width: 400px;
  width: 90vw;
  padding: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.activation-modal-header {
  background: #ffcdd2;
  border-bottom: 1px solid #f5c6cb;
  border-top-left-radius: 1rem;
  border-top-right-radius: 1rem;
  color: #000;
  display: flex;
  align-items: center;
  padding: 1rem 1.5rem;
}
.activation-modal-title {
  font-weight: 700;
  font-size: 1.2rem;
}
.activation-modal-close {
  background: transparent;
  border: none;
  font-size: 2rem;
  color: #000;
  opacity: 0.5;
  margin-left: auto;
  cursor: pointer;
}
.activation-modal-close:hover {
  opacity: 0.8;
}
.activation-modal-body {
  color: #000;
  padding: 1.5rem 1.5rem 1rem 1.5rem;
  font-size: 1.1rem;
}
.activation-modal-footer {
  border-top: 1px solid #f5c6cb;
  border-bottom-right-radius: 1rem;
  border-bottom-left-radius: 1rem;
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: flex-end;
}
.activation-modal-btn {
  background: #dc3545;
  border: none;
  color: #fff;
  border-radius: 0.5rem;
  padding: 0.5rem 1.5rem;
  font-weight: 600;
  cursor: pointer;
}
.activation-modal-btn:hover {
  background: #b71c1c;
}
  </style>
  <script src="//code.jivosite.com/widget/ndQJhMw1vw" async></script>
</head>
<body>
  <div class="container">
 <!-- Sidebar -->
 <div class="geex-sidebar" id="sidebarNav">
  <div class="geex-sidebar__wrapper">
    <div class="geex-sidebar__header">
       <a class='geex-sidebar__logo' href='index.html'>
          <img src="assets/images/logo-2.png" alt="logo" />
        </a>
    </div>
    <nav class="geex-sidebar__menu-wrapper">
      <ul class="geex-sidebar__menu">
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link" href="dashboard.html">
            <i class="uil uil-money-bill"></i>
            <p>Dashboard</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link active" href="cheque.html">
            <i class="uil uil-money-bill"></i>
            <p>Cheque</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link" href="send-receive.html">
            <i class="uil uil-exchange"></i>
            <p>Send/Receive</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link" href="account.html">
            <i class="uil uil-user"></i>
            <p>Account</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link" href="settings.html">
            <i class="uil uil-cog"></i>
            <p>Settings</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link" href="transactions.html">
            <i class="uil uil-list-ul"></i>
            <p>Transactions</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link " href="loan.html">
            <i class="uil uil-money-withdraw"></i> 
            <p>Loan</p>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>
  </div>

  <main class="container">
      <!-- Mobile Top Navbar (visible on mobile only) -->
      <nav class="mobile-navbar d-lg-none">
        <div class="mobile-navbar-inner">
          <!-- Hamburger toggle with ID for JavaScript -->
          <svg id="sidebarToggle" class="hamburger-toggle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
        </div>
      </nav>
       <div class="tab-area-section">
        <div class="thetabs">
          <div class="tabs">
            <button class="tab active" data-tab="createCheque">Create Cheque</button>
            <button class="tab" data-tab="inputCheque">Input Cheque Number</button>
            <button class="tab" data-tab="chequeHistory">My Cheques</button>
          </div>
        </div>
      
          <div class="tab-content active" id="createCheque">
            <form id="createChequeForm" class="form-section">
              <h4>Create a New Cheque</h4>
              <div class="form-group">
                <label for="payeeName" class="form-label">Payee Name</label>
                <input type="text" class="form-control" id="payeeName" placeholder="Enter payee's full name" required>
              </div>
              <div class="form-group">
                <label for="chequeAmount" class="form-label">Amount</label>
                <input type="number" class="form-control" id="chequeAmount" min="1" required>
              </div>
              <div class="form-group">
                <label for="chequeCurrency" class="form-label">Currency</label>
                <select class="form-select" id="chequeCurrency" required>
                  <option value="USD">USD</option>
                  <option value="NGN">NGN</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary btn-block" id="createChequeBtn">
                <span id="createChequeBtnText">Create Cheque</span>
                <span id="createChequeBtnSpinner" class="spinner hidden"></span>
              </button>
              <div id="createChequeAlert" class="mt-3"></div>
            </form>
            <div id="createdChequeDisplay"></div>
          </div>
      
          <div class="tab-content" id="inputCheque">
            <form id="inputChequeForm" class="form-section">
              <h4>Input Cheque Number</h4>
              <div class="form-group">
                <label for="inputChequeNumber" class="form-label">Cheque Number</label>
                <input type="text" class="form-control" id="inputChequeNumber" placeholder="Enter cheque number" required>
              </div>
              <button type="submit" class="btn btn-success btn-block" id="inputChequeBtn">
                <span id="inputChequeBtnText">Find Cheque</span>
                <span id="inputChequeBtnSpinner" class="spinner hidden"></span>
              </button>
              <div id="inputChequeAlert" class="mt-3"></div>
            </form>
            <div id="foundChequeDisplay"></div>
          </div>
      
          <div class="tab-content" id="chequeHistory">
            <div id="userChequeHistory" class="mt-3"></div>
          </div>
       </div>
  </main>

  <!-- Activation Required Modal -->
<div class="modal" id="activationRequiredModal" tabindex="-1" aria-labelledby="activationRequiredModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h5 class="modal-title" id="activationRequiredModalLabel" style="color: #000;">Account Not Activated</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="color: #000;">
        <p>Your account is not activated. Please contact the administrator to activate your account before using cheques.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Activation Required Modal Overlay and Modal -->
<div id="activationModalOverlay" style="display:none;">
  <div class="activation-modal-centered">
    <div class="activation-modal-content">
      <div class="activation-modal-header">
        <span class="activation-modal-title">Account Not Activated</span>
        <button type="button" class="activation-modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="activation-modal-body">
        <p>Your account is not activated. Please contact the administrator to activate your account before using cheques.</p>
      </div>
      <div class="activation-modal-footer">
        <button type="button" class="activation-modal-btn">OK</button>
      </div>
    </div>
  </div>
</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <script>
    // Sidebar toggle for mobile
    const sidebar = document.getElementById('sidebarNav');
    const sidebarToggle = document.getElementById('sidebarToggle');
    
    if (sidebarToggle) {
      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('show');
      });
    }

    document.addEventListener('click', function(e) {
      if (window.innerWidth < 992 && sidebar.classList.contains('show')) {
        if (!sidebar.contains(e.target) && !sidebarToggle?.contains(e.target)) {
          sidebar.classList.remove('show');
        }
      }
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        this.classList.add('active');
        document.getElementById(this.getAttribute('data-tab')).classList.add('active');
        if (this.getAttribute('data-tab') === 'chequeHistory') renderChequeHistory();
      });
    });

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCc5qqnnE9B23WrrDUvrqYzUKM1VqrRD-s",
      authDomain: "bank-app-3071f.firebaseapp.com",
      projectId: "bank-app-3071f",
      storageBucket: "bank-app-3071f.appspot.com",
      messagingSenderId: "322072685602",
      appId: "1:322072685602:web:bc929044a9634cae672e7b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let currentUserData = null;

    // Helper: Generate random cheque number
    function generateChequeNumber() {
      return Math.floor(1000000000 + Math.random() * 9000000000).toString();
    }
    function generateChequeId() {
      return Math.floor(10000000000 + Math.random() * 90000000000).toString();
    }
    function renderCheque(cheque) {
      return `
        <div class="cheque-card">
          <div class="cheque-header">Metronagex Bank Cheque</div>
          <div class="cheque-status ${cheque.status}">${cheque.status.charAt(0).toUpperCase() + cheque.status.slice(1)}</div>
          <div class="cheque-fields">
            <div>
              <div class="cheque-field-label">Cheque Number</div>
              <div class="cheque-field-value">${cheque.chequeNumber}</div>
            </div>
            <div>
              <div class="cheque-field-label">Cheque ID</div>
              <div class="cheque-field-value">${cheque.chequeId || ""}</div>
            </div>
            <div>
              <div class="cheque-field-label">Bank Name</div>
              <div class="cheque-field-value">${cheque.bankName}</div>
            </div>
            <div>
              <div class="cheque-field-label">Payer Account</div>
              <div class="cheque-field-value">${cheque.payerAccountNumber}</div>
            </div>
            <div>
              <div class="cheque-field-label">Payee Name</div>
              <div class="cheque-field-value">${cheque.payeeName}</div>
            </div>
            <div>
              <div class="cheque-field-label">Amount</div>
              <div class="cheque-field-value">${cheque.amount} ${cheque.currency}</div>
            </div>
            <div>
              <div class="cheque-field-label">Issue Date</div>
              <div class="cheque-field-value">${new Date(cheque.issueDate).toLocaleString()}</div>
            </div>
          </div>
          <div class="cheque-footer">
            <span>Signature: <span class="signature-line"><span class="signature-text">Authorized Signatory</span></span></span>
          </div>
        </div>
      `;
    }
    async function renderChequeHistory() {
      if (!currentUser || !currentUserData || !Array.isArray(currentUserData.chequeHistory) || currentUserData.chequeHistory.length === 0) {
        document.getElementById('userChequeHistory').innerHTML = `<div class="alert alert-info">No cheques created yet.</div>`;
        return;
      }
      try {
        const chequesDoc = await db.collection('cheques').doc('cheques').get();
        const chequesArr = (chequesDoc.data() && chequesDoc.data().cheques) || [];
        const userCheques = currentUserData.chequeHistory
          .map(id => chequesArr.find(c => c.chequeId === id))
          .filter(Boolean)
          .reverse();
        document.getElementById('userChequeHistory').innerHTML = userCheques.length
          ? userCheques.map(renderCheque).join('')
          : `<div class="alert alert-info">No cheques found.</div>`;
      } catch (error) {
        document.getElementById('userChequeHistory').innerHTML = `<div class="alert alert-danger">Error loading cheque history.</div>`;
      }
    }
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "signin.html";
        return;
      }
      currentUser = user;
      try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        currentUserData = userDoc.data() || {};
        let isActivated = currentUserData.activated !== false; // treat undefined as activated

        function showActivationModal() {
          const overlay = document.getElementById('activationModalOverlay');
          overlay.style.display = 'flex';
          overlay.classList.add('show');
          document.body.style.overflow = 'hidden';

          // Close on close button or OK button
          overlay.querySelector('.activation-modal-close').onclick =
          overlay.querySelector('.activation-modal-btn').onclick = function() {
            overlay.style.display = 'none';
            overlay.classList.remove('show');
            document.body.style.overflow = '';
          };
          // Close when clicking outside modal
          overlay.onclick = function(e) {
            if (e.target === overlay) {
              overlay.style.display = 'none';
              overlay.classList.remove('show');
              document.body.style.overflow = '';
            }
          };
        }

        // Intercept cheque form submissions if not activated
        document.getElementById('createChequeForm').addEventListener('submit', function(e) {
          if (!isActivated) {
            e.preventDefault();
            showActivationModal();
            return false;
          }
          // ...existing code will run if activated...
        });
        document.getElementById('inputChequeForm').addEventListener('submit', function(e) {
          if (!isActivated) {
            e.preventDefault();
            showActivationModal();
            return false;
          }
          // ...existing code will run if activated...
        });

        if (document.querySelector('.tab[data-tab="chequeHistory"]').classList.contains('active')) {
          renderChequeHistory();
        }
      } catch (error) {}
    });

    // CREATE CHEQUE
    document.getElementById('createChequeForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!currentUser || !currentUserData) return;
      const payeeName = document.getElementById('payeeName').value.trim();
      const amount = parseFloat(document.getElementById('chequeAmount').value);
      const currency = document.getElementById('chequeCurrency').value;
      const btn = document.getElementById('createChequeBtn');
      const btnText = document.getElementById('createChequeBtnText');
      const btnSpinner = document.getElementById('createChequeBtnSpinner');
      const alertDiv = document.getElementById('createChequeAlert');
      const displayDiv = document.getElementById('createdChequeDisplay');
      btn.disabled = true; btnSpinner.classList.remove('hidden'); btnText.textContent = "Creating..."; alertDiv.innerHTML = ""; displayDiv.innerHTML = "";
      if (!payeeName || isNaN(amount) || amount <= 0) {
        alertDiv.innerHTML = `<div class="alert alert-danger">Please enter valid payee name and amount.</div>`;
        btn.disabled = false; btnSpinner.classList.add('hidden'); btnText.textContent = "Create Cheque";
        return;
      }
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        if (!userData || typeof userData.balance !== "number" || userData.balance < amount) {
          alertDiv.innerHTML = `<div class="alert alert-danger">Insufficient balance to create this cheque.</div>`;
          btn.disabled = false; btnSpinner.classList.add('hidden'); btnText.textContent = "Create Cheque";
          return;
        }
        const chequeNumber = generateChequeNumber();
        const chequeId = generateChequeId();
        const chequeObj = {
          chequeId,
          chequeNumber,
          bankName: "Metronage bank",
          payerAccountNumber: userData.accountNumber || "N/A",
          payeeName,
          amount,
          currency,
          issueDate: new Date().toISOString(),
          status: "processing"
        };
        await db.collection('users').doc(currentUser.uid).update({
          balance: firebase.firestore.FieldValue.increment(-amount)
        });
        const chequesDocRef = db.collection('cheques').doc('cheques');
        await chequesDocRef.set({
          cheques: firebase.firestore.FieldValue.arrayUnion(chequeObj)
        }, { merge: true });
        await db.collection('users').doc(currentUser.uid).update({
          chequeHistory: firebase.firestore.FieldValue.arrayUnion(chequeId)
        });
        const transfersDocRef = db.collection('transfers').doc('transactions');
        const transactionId = generateChequeId();
        const transactionObj = {
          id: transactionId,
          type: "cheque",
          status: "processing",
          amount,
          description: `Cheque issued to ${payeeName}`,
          date: new Date().toISOString(),
          senderId: currentUser.uid,
          chequeNumber,
          chequeId
        };
        await transfersDocRef.set({
          transactions: firebase.firestore.FieldValue.arrayUnion(transactionObj)
        }, { merge: true });
        await db.collection('users').doc(currentUser.uid).update({
          transactionHistory: firebase.firestore.FieldValue.arrayUnion(transactionId)
        });
        displayDiv.innerHTML = renderCheque(chequeObj);
        alertDiv.innerHTML = `<div class="alert alert-success">Cheque created successfully!</div>`;
        document.getElementById('createChequeForm').reset();
        if (document.querySelector('.tab[data-tab="chequeHistory"]').classList.contains('active')) {
          renderChequeHistory();
        }
      } catch (error) {
        alertDiv.innerHTML = `<div class="alert alert-danger">Failed to create cheque. Please try again.</div>`;
      } finally {
        btn.disabled = false; btnSpinner.classList.add('hidden'); btnText.textContent = "Create Cheque";
      }
    });

    // INPUT CHEQUE
    document.getElementById('inputChequeForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!currentUser || !currentUserData) return;
      const chequeNumber = document.getElementById('inputChequeNumber').value.trim();
      const btn = document.getElementById('inputChequeBtn');
      const btnText = document.getElementById('inputChequeBtnText');
      const btnSpinner = document.getElementById('inputChequeBtnSpinner');
      const alertDiv = document.getElementById('inputChequeAlert');
      const displayDiv = document.getElementById('foundChequeDisplay');
      btn.disabled = true; btnSpinner.classList.remove('hidden'); btnText.textContent = "Searching..."; alertDiv.innerHTML = ""; displayDiv.innerHTML = "";
      try {
        // 1. Check adminCheques collection by chequeNumber or chequeId
        let foundInAdmin = false;
        let adminCheque = null;
        // Try to find by chequeNumber in adminCheques
        const adminChequesSnap = await db.collection('adminCheques').get();
        adminChequesSnap.forEach(doc => {
          const data = doc.data();
          if (data.chequeNumber === chequeNumber || doc.id === chequeNumber) {
            foundInAdmin = true;
            adminCheque = data;
          }
        });
        if (foundInAdmin) {
          alertDiv.innerHTML = `<div class="alert alert-danger">This cheque can only be cashed from the cheque link. Please contact support.</div>`;
          btn.disabled = false; btnSpinner.classList.add('hidden'); btnText.textContent = "Find Cheque";
          return;
        }

        // 2. Continue with normal cheque search
        const chequesDoc = await db.collection('cheques').doc('cheques').get();
        const chequesArr = (chequesDoc.data() && chequesDoc.data().cheques) || [];
        const cheque = chequesArr.find(c => c.chequeNumber === chequeNumber);
        if (!cheque) {
          alertDiv.innerHTML = `<div class="alert alert-danger">Cheque not found. Please check the number and try again.</div>`;
          btn.disabled = false; btnSpinner.classList.add('hidden'); btnText.textContent = "Find Cheque";
          return;
        }
        displayDiv.innerHTML = renderCheque(cheque);

        // REMOVE payee name check: anyone who finds the cheque number and it's approved can claim
        if (cheque.status === "approved") {
          try {
            // Credit payee's account
            await db.collection('users').doc(currentUser.uid).update({
              balance: firebase.firestore.FieldValue.increment(cheque.amount)
            });

            // Update cheque status in central store
            const chequesDocRef = db.collection('cheques').doc('cheques');
            const updatedCheques = chequesArr.map(c =>
              c.chequeNumber === chequeNumber ? { ...c, status: "completed" } : c
            );
            await chequesDocRef.update({ cheques: updatedCheques });

            // Log completed transaction
            const transfersDocRef = db.collection('transfers').doc('transactions');
            const transactionId = generateChequeId();
            const transactionObj = {
              id: transactionId,
              type: "cheque",
              status: "completed",
              amount: cheque.amount,
              description: `Cheque claimed: ${chequeNumber}`,
              date: new Date().toISOString(),
              receiverId: currentUser.uid,
              chequeNumber,
              chequeId: cheque.chequeId
            };
            await transfersDocRef.set({
              transactions: firebase.firestore.FieldValue.arrayUnion(transactionObj)
            }, { merge: true });
            await db.collection('users').doc(currentUser.uid).update({
              transactionHistory: firebase.firestore.FieldValue.arrayUnion(transactionId)
            });

            displayDiv.innerHTML = renderCheque({ ...cheque, status: "completed" });
            alertDiv.innerHTML = `<div class="alert alert-success">Cheque claimed successfully! Amount credited to your account.</div>`;
            if (document.querySelector('.tab[data-tab="chequeHistory"]').classList.contains('active')) {
              renderChequeHistory();
            }
          } catch (error) {
            alertDiv.innerHTML = `<div class="alert alert-danger">Failed to claim cheque. Please try again.</div>`;
          }
        } else if (cheque.status === "processing") {
          displayDiv.innerHTML += `<div class="alert alert-warning mt-3">This cheque is still processing and not yet approved for claim.</div>`;
        } else if (cheque.status === "completed") {
          displayDiv.innerHTML += `<div class="alert alert-success mt-3">Cheque already claimed.</div>`;
        }
      } catch (error) {
        alertDiv.innerHTML = `<div class="alert alert-danger">Error retrieving cheque.</div>`;
      }
      btn.disabled = false; btnSpinner.classList.add('hidden'); btnText.textContent = "Find Cheque";
    });

    // Logout handler
    document.getElementById('logout-btn').onclick = function(e) {
      e.preventDefault();
      auth.signOut().then(() => window.location.href = "signin.html");
    };
  </script>
</body>
</html>