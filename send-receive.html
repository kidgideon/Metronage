<!doctype html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Send/Receive - Metronagex Bank</title>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@iconscout/unicons@4.0.8/css/line.min.css">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon.svg">
    <link rel="stylesheet" href="./styles/index.css">
    <style>
      /* Base Styles */
      :root {
        --primary:  rgb(59, 59, 59);
        --primary-hover:  rgb(59, 59, 59);
        --success: rgb(59, 59, 59);
        --success-hover: #218838;
        --danger: #dc3545;
        --danger-hover: #c82333;
        --secondary: #6c757d;
        --secondary-hover: #5a6268;
        --light: #f8f9fa;
        --dark: #343a40;
        --white: #fff;
        --gray-100: #f8f9fa;
        --gray-200: #e9ecef;
        --gray-300: #dee2e6;
        --gray-400: #ced4da;
        --gray-500: #adb5bd;
        --gray-600: #6c757d;
        --gray-700: #495057;
        --gray-800: #343a40;
        --gray-900: #212529;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        --shadow-none: 0 0 #0000;
        --border-radius-sm: 0.2rem;
        --border-radius: 0.25rem;
        --border-radius-md: 0.3rem;
        --border-radius-lg: 0.5rem;
        --border-radius-xl: 1rem;
        --border-radius-2xl: 1.25rem;
        --border-radius-full: 9999px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: black;
      }


      a {
        text-decoration: none;
        color: inherit;
      }

      button {
        cursor: pointer;
        font-family: inherit;
      }

      input, textarea, select {
        font-family: inherit;
      }

      /* Utility Classes */
      .d-none {
        display: none !important;
      }

      .d-flex {
        display: flex !important;
      }

      .flex-column {
        flex-direction: column !important;
      }

      .flex-row {
        flex-direction: row !important;
      }

      .align-items-center {
        align-items: center !important;
      }

      .justify-content-between {
        justify-content: space-between !important;
      }

      .justify-content-center {
        justify-content: center !important;
      }

      .gap-3 {
        gap: 1rem !important;
      }

      .w-100 {
        width: 100% !important;
      }

      .fw-bold {
        font-weight: 600 !important;
      }

      .mb-0 {
        margin-bottom: 0 !important;
      }

      .mb-1 {
        margin-bottom: 0.25rem !important;
      }

      .mb-2 {
        margin-bottom: 0.5rem !important;
      }

      .mb-3 {
        margin-bottom: 1rem !important;
      }

      .mb-4 {
        margin-bottom: 1.5rem !important;
      }

      .mt-1 {
        margin-top: 0.25rem !important;
      }

      .mt-2 {
        margin-top: 0.5rem !important;
      }

      .mt-3 {
        margin-top: 1rem !important;
      }

      .mt-4 {
        margin-top: 1.5rem !important;
      }

      .py-4 {
        padding-top: 1.5rem !important;
        padding-bottom: 1.5rem !important;
      }


      .text-white {
        color: var(--white) !important;
      }

      .text-danger {
        color: var(--danger) !important;
      }

      .text-success {
        color: var(--success) !important;
      }

      .bg-white {
        background-color: var(--white) !important;
      }

      .bg-primary {
        background-color: var(--primary) !important;
      }

      .bg-success {
        background-color: var(--success) !important;
      }

      .border-0 {
        border: none !important;
      }

      .border-bottom {
        border-bottom: 1px solid var(--gray-200) !important;
      }

      .shadow-sm {
        box-shadow: var(--shadow-sm) !important;
      }

      .shadow {
        box-shadow: var(--shadow) !important;
      }

      .rounded {
        border-radius: var(--border-radius) !important;
      }

      .rounded-lg {
        border-radius: var(--border-radius-lg) !important;
      }

      .rounded-xl {
        border-radius: var(--border-radius-xl) !important;
      }

      .rounded-2xl {
        border-radius: var(--border-radius-2xl) !important;
      }

      /* Spinner */
      .spinner-border {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        vertical-align: -0.125em;
        border: 0.15em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border 0.75s linear infinite;
      }

      .spinner-border-sm {
        width: 0.75rem;
        height: 0.75rem;
        border-width: 0.1em;
      }

      @keyframes spinner-border {
        to { transform: rotate(360deg); }
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        text-align: center;
        vertical-align: middle;
        user-select: none;
        background-color: transparent;
        border: 1px solid transparent;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: var(--border-radius-lg);
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, 
                    border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }

      .btn:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }

      .btn-primary {
        color: var(--white);
        background-color: var(--primary);
        border-color: var(--primary);
      }

      .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
      }

      .btn-outline-primary {
        color: var(--primary);
        border-color: var(--primary);
        background-color: transparent;
      }

      .btn-outline-primary:hover {
        color: var(--white);
        background-color: var(--primary);
        border-color: var(--primary);
      }

      .btn-secondary {
        color: var(--white);
        background-color: var(--secondary);
        border-color: var(--secondary);
      }

      .btn-secondary:hover {
        background-color: var(--secondary-hover);
        border-color: var(--secondary-hover);
      }

      .btn-success {
        color: var(--white);
        background-color: var(--success);
        border-color: var(--success);
      }

      .btn-success:hover {
        background-color: var(--success-hover);
        border-color: var(--success-hover);
      }

      .btn-danger {
        color: var(--white);
        background-color: var(--danger);
        border-color: var(--danger);
      }

      .btn-danger:hover {
        background-color: var(--danger-hover);
        border-color: var(--danger-hover);
      }

      .btn-outline-secondary {
        color: var(--secondary);
        border-color: var(--secondary);
        background-color: transparent;
      }

      .btn-outline-secondary:hover {
        color: var(--white);
        background-color: var(--secondary);
        border-color: var(--secondary);
      }

      .btn.active {
        box-shadow: var(--shadow-sm);
      }

      /* Forms */
      .form-control {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        color: var(--gray-700);
        background-color: var(--white);
        background-clip: padding-box;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }

      .form-control:focus {
        color: var(--gray-700);
        background-color: var(--white);
        border-color: var(--primary);
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(106, 130, 251, 0.25);
      }

      .form-control::placeholder {
        color: var(--gray-500);
        opacity: 1;
      }

      .form-control:disabled {
        background-color: var(--gray-200);
        opacity: 1;
      }

      .form-control[readonly] {
        background-color: var(--gray-200);
      }

      .form-label {
        display: inline-block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      /* Input Group */
      .input-group {
        position: relative;
        display: flex;
        flex-wrap: wrap;
        align-items: stretch;
        width: 100%;
      }

      .input-group > .form-control {
        position: relative;
        flex: 1 1 auto;
        width: 1%;
        min-width: 0;
      }

      .input-group > .form-control:not(:last-child) {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
      }

      .input-group > .btn {
        position: relative;
        z-index: 2;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
      }

      /* Alerts */
      .alert {
        position: relative;
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: var(--border-radius);
      }

      .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
      }

      .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }

      /* Cards */
      .card {
        position: relative;
        display: flex;
        flex-direction: column;
        min-width: 0;
        word-wrap: break-word;
        background-color: var(--white);
        background-clip: border-box;
        border-radius: var(--border-radius-2xl) !important;
        box-shadow: 0 2px 24px 0 rgba(80, 80, 120, 0.08) !important;
        border: none !important;
      }

      .card-header {
        padding: 1rem 1.5rem;
        margin-bottom: 0;
        background-color: rgba(0, 0, 0, 0.03);
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
        border-radius: var(--border-radius-2xl) var(--border-radius-2xl) 0 0 !important;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .card-body {
        flex: 1 1 auto;
        padding: 1.5rem;
        background-color: rgb(37, 37, 37);
      }

      .particular {
        width: 250px;
        margin: 30px;
        border-radius: 10px;
      }
      /* Modals */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1060;
        display: none;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        outline: 0;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal.show {
        display: block;
      }

      .modal-dialog {
        position: relative;
        width: auto;
        margin: 0.5rem;
        pointer-events: none;
      }

      .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
        transform: translate(0, -50px);
      }

      .modal.show .modal-dialog {
        transform: none;
      }

      .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - 1rem);
      }

      .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: var(--white);
        background-clip: padding-box;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: var(--border-radius-lg);
        outline: 0;
      }

      .modal-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 1rem 1rem;
        border-bottom: 1px solid var(--gray-200);
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
      }

      .modal-title {
        margin-bottom: 0;
        line-height: 1.5;
      }

      .modal-body {
        position: relative;
        flex: 1 1 auto;
        padding: 1rem;
      }

      .modal-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 1rem;
        border-top: 1px solid var(--gray-200);
        border-bottom-right-radius: var(--border-radius);
        border-bottom-left-radius: var(--border-radius);
      }

      .modal-footer > * {
        margin: 0.25rem;
      }

      .btn-close {
        padding: 0.5rem 0.5rem;
        margin: -0.5rem -0.5rem -0.5rem auto;
        background-color: transparent;
        border: 0;
        border-radius: var(--border-radius);
        opacity: 0.5;
      }

      .btn-close:hover {
        opacity: 0.75;
      }

      /* Tab Content */
      .tab-content {
        margin-top: 1rem;
      }

      .tab-pane {
        display: none;
      }

      .tab-pane.active {
        display: block;
      }

      /* Responsive */
      @media (min-width: 576px) {
        .container {
          max-width: 540px;
        }
        .modal-dialog {
          max-width: 500px;
          margin: 1.75rem auto;
        }
      }

      @media (min-width: 768px) {
        .container {
          max-width: 720px;
        }
        .geex-content__wrapper .container {
          padding: 0 0.5rem !important;
        }
      }

      @media (min-width: 992px) {
        .container {
          max-width: 960px;
        }
        .main-content {
          padding-top: 2rem;
          margin: 0px;
        }
        .sidebar {
          transform: translateX(0) !important;
        }
      }

      @media (min-width: 1200px) {
        .container {
          max-width: 1140px;
        }
      }

      @media (max-width: 767.98px) {
        .card {
          margin-bottom: 1.5rem;
        }

        body {
          padding-left: 0px;
        }
      }

      @media (max-width: 991.98px) {
        .sidebar {
          transform: translateX(-100%);
          padding-top: 56px;
        }
        .sidebar.show {
          transform: translateX(0);
        }
        .main-content {
          margin-left: 0;
          padding-top: 70px;
        }
        .sidebar .sidebar-logo {
          width: 100vw;
        }
      }
    </style>
</head>
<body>
<div class="container">
 <!-- Sidebar -->
 <div class="geex-sidebar" id="sidebarNav">
  <div class="geex-sidebar__wrapper">
    <div class="geex-sidebar__header">
      <a class='geex-sidebar__logo' href='index.html'>
        <img src="assets/img/logo-dark.svg" alt="logo" />
      </a>
    </div>
    <nav class="geex-sidebar__menu-wrapper">
      <ul class="geex-sidebar__menu">
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link" href="dashboard.html">
            <i class="uil uil-money-bill"></i>
            <p>Dashboard</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link" href="cheque.html">
            <i class="uil uil-money-bill"></i>
            <p>Cheque</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link active" href="send-receive.html">
            <i class="uil uil-exchange"></i>
            <p>Send/Receive</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link" href="account.html">
            <i class="uil uil-user"></i>
            <p>Account</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link" href="settings.html">
            <i class="uil uil-cog"></i>
            <p>Settings</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link" href="transactions.html">
            <i class="uil uil-list-ul"></i>
            <p>Transactions</p>
          </a>
        </li>
        <li class="geex-sidebar__menu__item">
          <a class="geex-sidebar__menu__link " href="loan.html">
            <i class="uil uil-money-withdraw"></i> 
            <p>Loan</p>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>
  <div class="scrollable-area">
      <!-- Mobile Top Navbar (visible on mobile only) -->
      <nav class="mobile-navbar d-lg-none">
        <div class="mobile-navbar-inner">
          <!-- Hamburger toggle with ID for JavaScript -->
          <svg id="sidebarToggle" class="hamburger-toggle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
        </div>
      </nav>


    <main class="main-content">
      <div class="geex-content">
          <div class="geex-content__wrapper">
              <div class="container py-4">
                  <!-- User Bank Info Card -->
                  <div class="row justify-content-center mb-4">
                      <div class="col-12 col-md-8 col-lg-7">
                          <div class="card particular shadow border-0 p-3">
                              <div class="card-body d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
                                  <div class="mb-3 mb-md-0">
                                      <h5 class="mb-1">Account Balance</h5>
                                      <h2 id="user-balance" class="mb-0"><span class="spinner-border spinner-border-sm"></span></h2>
                                  </div>
                                  <div>
                                      <h6 class="mb-1">Account Number</h6>
                                      <div id="user-account-number" class="fw-bold"><span class="spinner-border spinner-border-sm"></span></div>
                                      <h6 class="mb-1 mt-3">Account Name</h6>
                                      <div id="user-account-name" class="fw-bold"><span class="spinner-border spinner-border-sm"></span></div>
                                      <h6 class="mb-1 mt-3">Bank Name</h6>
                                      <div id="user-bank-name" class="fw-bold">Metronagex Bank</div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
  
                  <!-- Transfer/Receive Form -->
                  <div class="row justify-content-center">
                      <div class="col-12 col-md-8 col-lg-7">
                          <div class="card shadow border-0 mb-4">
                              <div class="card-header bg-primary text-white">
                                  <h5 class="mb-0">Send Money</h5>
                              </div>
                              <div class="card-body">
                                  <div class="d-flex justify-content-center mb-4 gap-3">
                                    <button id="btnGeex" class="btn btn-primary fw-bold active" type="button">
                                      Send to Geex Bank
                                    </button>
                                    <button id="btnOther" class="btn btn-outline-primary fw-bold" type="button">
                                      Send to Other Bank
                                    </button>
                                  </div>
                                 
                                  <div class="tab-content" id="transferTabContent">
                                    <!-- Geex Bank Transfer Form -->
                                    <div class="tab-pane fade show active" id="geex-transfer" role="tabpanel" aria-labelledby="geex-tab">
                                      <form id="transferFormGeex">
                                        <div class="mb-3">
                                          <label for="recipientAccount" class="form-label">Recipient Account Number</label>
                                          <input type="text" class="form-control" id="recipientAccount" required>
                                        </div>
                                        <div class="mb-3">
                                          <label for="amount" class="form-label">Amount</label>
                                          <input type="number" class="form-control" id="amount" min="1" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100" id="sendBtnGeex">
                                          <span id="sendBtnTextGeex">Send</span>
                                          <span id="sendBtnSpinnerGeex" class="spinner-border spinner-border-sm d-none"></span>
                                        </button>
                                      </form>
                                      <div id="transferAlertGeex" class="mt-3"></div>
                                    </div>
                                    <!-- Other Bank Transfer Form -->
                                    <div class="tab-pane fade" id="other-transfer" role="tabpanel" aria-labelledby="other-tab">
                                      <form id="transferFormOther">
                                        <div class="mb-3">
                                          <label for="recipientAccountOther" class="form-label">Recipient Account Number</label>
                                          <input type="text" class="form-control" id="recipientAccountOther" required>
                                        </div>
                                        <div class="mb-3">
                                          <label for="bankNameOther" class="form-label">Bank Name</label>
                                          <input type="text" class="form-control" id="bankNameOther" required>
                                        </div>
                                        <div class="mb-3">
                                          <label for="amountOther" class="form-label">Amount</label>
                                          <input type="number" class="form-control" id="amountOther" min="1" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100" id="sendBtnOther">
                                          <span id="sendBtnTextOther">Send</span>
                                          <span id="sendBtnSpinnerOther" class="spinner-border spinner-border-sm d-none"></span>
                                        </button>
                                      </form>
                                      <div id="transferAlertOther" class="mt-3"></div>
                                    </div>
                                  </div>
                              </div>
                          </div>
                          <div class="card shadow border-0">
                              <div class="card-header bg-success text-white">
                                  <h5 class="mb-0">Receive Money</h5>
                              </div>
                              <div class="card-body">
                                  <p>Share your account number with the sender to receive money.</p>
                                  <div class="input-group">
                                      <input type="text" class="form-control" id="receiveAccountNumber" readonly>
                                      <button class="btn btn-outline-secondary" type="button" id="copyAccountBtn">Copy</button>
                                  </div>
                                  <div id="copyAlert" class="mt-2"></div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </main>
  </div>
</div>

<!-- JavaScript Libraries -->
<script src="assets/vendor/js/jquery/jquery-3.5.1.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

<!-- Recipient Confirmation Modal -->
<div class="modal" id="confirmRecipientModal" tabindex="-1" aria-labelledby="confirmRecipientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmRecipientModalLabel">Confirm Recipient</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Recipient Name: <span id="recipientFullName"></span></p>
        <p>Account Number: <span id="recipientAccountNumber"></span></p>
        <p>Amount: $<span id="confirmAmount"></span></p>
        <div id="recipientModalError" class="text-danger"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelTransferBtn" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmTransferBtn">Yes, Continue</button>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal" id="transferSuccessModal" tabindex="-1" aria-labelledby="transferSuccessModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="transferSuccessModalLabel">Transfer Sent</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Your transfer has been sent successfully and is waiting for approval.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Transaction Pin Modal -->
<div class="modal" id="transactionPinModal" tabindex="-1" aria-labelledby="transactionPinModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transactionPinModalLabel">Enter Transaction Pin</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="password" class="form-control mb-2" id="transactionPinInput" maxlength="6" placeholder="Enter your transaction pin" autocomplete="off">
        <div id="transactionPinError" class="text-danger"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitTransactionPinBtn">Continue</button>
      </div>
    </div>
  </div>
</div>

<!-- Create Pin Modal -->
<div class="modal" id="createPinModal" tabindex="-1" aria-labelledby="createPinModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createPinModalLabel">Create Transaction Pin</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="password" class="form-control mb-2" id="newPinInput" maxlength="6" placeholder="Create a 4-6 digit pin" autocomplete="off">
        <input type="password" class="form-control mb-2" id="confirmNewPinInput" maxlength="6" placeholder="Confirm pin" autocomplete="off">
        <div id="createPinError" class="text-danger"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="savePinBtn">Save Pin</button>
      </div>
    </div>
  </div>
</div>

<!-- Optional Description Modal -->
<div class="modal" id="descriptionModal" tabindex="-1" aria-labelledby="descriptionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="descriptionModalLabel">Add Description (Optional)</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control mb-2" id="transactionDescriptionInput" maxlength="100" placeholder="Description (optional)">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="skipDescriptionBtn">Skip</button>
        <button type="button" class="btn btn-primary" id="saveDescriptionBtn">Continue</button>
      </div>
    </div>
  </div>
</div>

<!-- Activation Required Modal -->
<div class="modal" id="activationRequiredModal" tabindex="-1" aria-labelledby="activationRequiredModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h5 class="modal-title" id="activationRequiredModalLabel" style="color: #000;">Account Not Activated</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="color: #000;">
        <p>Your account is not activated. Please contact the administrator to activate your account before making transfers.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCc5qqnnE9B23WrrDUvrqYzUKM1VqrRD-s",
    authDomain: "bank-app-3071f.firebaseapp.com",
    projectId: "bank-app-3071f",
    storageBucket: "bank-app-3071f.appspot.com",
    messagingSenderId: "322072685602",
    appId: "1:322072685602:web:bc929044a9634cae672e7b"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Modal functionality
  class Modal {
    constructor(element) {
      this.element = element;
      this.isShown = false;
      this.init();
    }

    init() {
      // Close modal when clicking outside or on close button
      this.element.addEventListener('click', (e) => {
        // FIX: Add closing parenthesis after .contains('btn-close')
        if (e.target === this.element || e.target.classList.contains('btn-close')) {
          this.hide();
        }
      });

      // Close modal when clicking cancel/dismiss buttons
      const dismissButtons = this.element.querySelectorAll('[data-dismiss="modal"]');
      dismissButtons.forEach(button => {
        button.addEventListener('click', () => this.hide());
      });
    }

    show() {
      this.element.style.display = 'block';
      this.element.classList.add('show');
      document.body.style.overflow = 'hidden';
      this.isShown = true;
    }

    hide() {
      this.element.style.display = 'none';
      this.element.classList.remove('show');
      document.body.style.overflow = '';
      this.isShown = false;
    }
  }

  // Initialize all modals
  const confirmRecipientModal = new Modal(document.getElementById('confirmRecipientModal'));
  const transferSuccessModal = new Modal(document.getElementById('transferSuccessModal'));
  const transactionPinModal = new Modal(document.getElementById('transactionPinModal'));
  const createPinModal = new Modal(document.getElementById('createPinModal'));
  const descriptionModal = new Modal(document.getElementById('descriptionModal'));
  const activationRequiredModal = new Modal(document.getElementById('activationRequiredModal'));

  // Show loading spinners
  function showTransferLoading() {
    document.getElementById('user-balance').innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
    document.getElementById('user-account-number').innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
    document.getElementById('user-account-name').innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
    document.getElementById('receiveAccountNumber').value = '';
  }
  showTransferLoading();

  let currentUserData = null;

  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "signin.html";
      return;
    }
    try {
      const userDoc = await db.collection('users').doc(user.uid).get();
      const data = userDoc.data() || {};
      currentUserData = data;

      // Display balance
      document.getElementById('user-balance').textContent = `$ ${data.balance ?? 0}`;

      // Display account number
      document.getElementById('user-account-number').textContent = data.accountNumber || 'N/A';
      document.getElementById('receiveAccountNumber').value = data.accountNumber || '';

      // Display account name (firstName + lastName or fallback)
      let accountName = '';
      if (data.firstName && data.lastName) {
        accountName = `${data.firstName} ${data.lastName}`;
      } else if (data.name) {
        accountName = data.name;
      } else if (user.email) {
        accountName = user.email.substring(0, 4);
      } else {
        accountName = 'User';
      }
      document.getElementById('user-account-name').textContent = accountName;

      // Bank name
      document.getElementById('user-bank-name').textContent = "Metronagex Bank";

      // Account activation check
      let isActivated = data.activated !== false; // treat undefined as activated

      // Helper to show the activation modal
      function showActivationModal() {
        const modal = document.getElementById('activationRequiredModal');
        modal.style.display = 'block';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        // Hide on close
        modal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
          btn.onclick = function() {
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.style.overflow = '';
          };
        });
        // Also close when clicking outside modal-content
        modal.onclick = function(e) {
          if (e.target === modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.style.overflow = '';
          }
        };
      }

      // Intercept form submissions if not activated
      document.getElementById('transferFormGeex').addEventListener('submit', function(e) {
        if (!isActivated) {
          e.preventDefault();
          showActivationModal();
          return false;
        }
        // ...existing code will run if activated...
      });
      document.getElementById('transferFormOther').addEventListener('submit', function(e) {
        if (!isActivated) {
          e.preventDefault();
          showActivationModal();
          return false;
        }
        // ...existing code will run if activated...
      });
    } catch (err) {
      document.getElementById('user-balance').innerHTML = `<div class="alert alert-danger">Failed to load user data.</div>`;
    }
  });

  // Copy account number
  document.getElementById('copyAccountBtn').onclick = function() {
    const input = document.getElementById('receiveAccountNumber');
    input.select();
    input.setSelectionRange(0, 99999);
    document.execCommand("copy");
    document.getElementById('copyAlert').innerHTML = `<div class="alert alert-success">Copied!</div>`;
    setTimeout(() => document.getElementById('copyAlert').innerHTML = '', 1500);
  };

  // Button toggling for transfer layouts
  const btnGeex = document.getElementById('btnGeex');
  const btnOther = document.getElementById('btnOther');
  const geexForm = document.getElementById('geex-transfer');
  const otherForm = document.getElementById('other-transfer');

  btnGeex.onclick = function() {
    btnGeex.classList.add('btn-primary', 'active');
    btnGeex.classList.remove('btn-outline-primary');
    btnOther.classList.remove('btn-primary', 'active');
    btnOther.classList.add('btn-outline-primary');
    geexForm.classList.add('show', 'active');
    otherForm.classList.remove('show', 'active');
  };

  btnOther.onclick = function() {
    btnOther.classList.add('btn-primary', 'active');
    btnOther.classList.remove('btn-outline-primary');
    btnGeex.classList.remove('btn-primary', 'active');
    btnGeex.classList.add('btn-outline-primary');
    otherForm.classList.add('show', 'active');
    geexForm.classList.remove('show', 'active');
  };

  let pendingTransfer = {};
  let pendingDescription = "";

  document.getElementById('confirmTransferBtn').onclick = async function() {
    if (!pendingTransfer.amount || !pendingTransfer.recipientDocId) return;
    // Check if user has a transactionPin
    try {
      const user = auth.currentUser;
      if (!user) return;
      const userDoc = await db.collection('users').doc(user.uid).get();
      const userData = userDoc.data() || {};
      if (userData.transactionPin) {
        // Prompt for pin
        document.getElementById('transactionPinInput').value = "";
        document.getElementById('transactionPinError').textContent = "";
        confirmRecipientModal.hide();
        setTimeout(() => transactionPinModal.show(), 300);
      } else {
        // Prompt to create pin
        document.getElementById('newPinInput').value = "";
        document.getElementById('confirmNewPinInput').value = "";
        document.getElementById('createPinError').textContent = "";
        confirmRecipientModal.hide();
        setTimeout(() => createPinModal.show(), 300);
      }
    } catch (err) {
      document.getElementById('recipientModalError').textContent = "Error checking pin. Try again.";
    }
  };

  // Handle transfer
  document.getElementById('transferFormGeex').addEventListener('submit', async function(e) {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user || !currentUserData) return;

    const recipientAccount = document.getElementById('recipientAccount').value.trim();
    const amount = parseFloat(document.getElementById('amount').value);

    // UI loading
    document.getElementById('sendBtnGeex').disabled = true;
    document.getElementById('sendBtnSpinnerGeex').classList.remove('d-none');
    document.getElementById('sendBtnTextGeex').textContent = 'Sending...';
    document.getElementById('transferAlertGeex').innerHTML = '';

    // Validation
    if (!recipientAccount || isNaN(amount) || amount <= 0) {
      document.getElementById('transferAlertGeex').innerHTML = `<div class="alert alert-danger">Invalid input.</div>`;
      document.getElementById('sendBtnGeex').disabled = false;
      document.getElementById('sendBtnSpinnerGeex').classList.add('d-none');
      document.getElementById('sendBtnTextGeex').textContent = 'Send';
      return;
    }
    if (recipientAccount === currentUserData.accountNumber) {
      document.getElementById('transferAlertGeex').innerHTML = `<div class="alert alert-danger">You cannot send money to yourself.</div>`;
      document.getElementById('sendBtnGeex').disabled = false;
      document.getElementById('sendBtnSpinnerGeex').classList.add('d-none');
      document.getElementById('sendBtnTextGeex').textContent = 'Send';
      return;
    }
    if ((currentUserData.balance ?? 0) < amount) {
      document.getElementById('transferAlertGeex').innerHTML = `<div class="alert alert-danger">Insufficient balance.</div>`;
      document.getElementById('sendBtnGeex').disabled = false;
      document.getElementById('sendBtnSpinnerGeex').classList.add('d-none');
      document.getElementById('sendBtnTextGeex').textContent = 'Send';
      return;
    }

    try {
      // Find recipient by account number
      const recipientSnap = await db.collection('users').where('accountNumber', '==', recipientAccount).limit(1).get();
      if (recipientSnap.empty) {
        document.getElementById('transferAlertGeex').innerHTML = `<div class="alert alert-danger">Recipient not found.</div>`;
        document.getElementById('sendBtnGeex').disabled = false;
        document.getElementById('sendBtnSpinnerGeex').classList.add('d-none');
        document.getElementById('sendBtnTextGeex').textContent = 'Send';
        return;
      }
      const recipientDoc = recipientSnap.docs[0];
      const recipientData = recipientDoc.data();

      // Prepare modal info
      const fullName = recipientData.firstName && recipientData.lastName
        ? `${recipientData.firstName} ${recipientData.lastName}`
        : (recipientData.name || recipientAccount);

      document.getElementById('recipientFullName').textContent = fullName;
      document.getElementById('recipientAccountNumber').textContent = recipientAccount;
      document.getElementById('confirmAmount').textContent = amount;
      document.getElementById('recipientModalError').textContent = '';

      // Store pending transfer info
      pendingTransfer = {
        recipientDocId: recipientDoc.id,
        recipientAccount,
        recipientFullName: fullName,
        amount
      };

      confirmRecipientModal.show();

      // Reset button UI
      document.getElementById('sendBtnGeex').disabled = false;
      document.getElementById('sendBtnSpinnerGeex').classList.add('d-none');
      document.getElementById('sendBtnTextGeex').textContent = 'Send';

    } catch (err) {
      document.getElementById('transferAlertGeex').innerHTML = `<div class="alert alert-danger">Error finding recipient.</div>`;
      document.getElementById('sendBtnGeex').disabled = false;
      document.getElementById('sendBtnSpinnerGeex').classList.add('d-none');
      document.getElementById('sendBtnTextGeex').textContent = 'Send';
    }
  });

  // Handle Other Bank Transfer
  document.getElementById('transferFormOther').addEventListener('submit', async function(e) {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user || !currentUserData) return;

    const recipientAccount = document.getElementById('recipientAccountOther').value.trim();
    const bankName = document.getElementById('bankNameOther').value.trim();
    const amount = parseFloat(document.getElementById('amountOther').value);

    // UI loading
    document.getElementById('sendBtnOther').disabled = true;
    document.getElementById('sendBtnSpinnerOther').classList.remove('d-none');
    document.getElementById('sendBtnTextOther').textContent = 'Sending...';
    document.getElementById('transferAlertOther').innerHTML = '';

    // Validation
    if (!recipientAccount || !bankName || isNaN(amount) || amount <= 0) {
      document.getElementById('transferAlertOther').innerHTML = `<div class="alert alert-danger">Invalid input.</div>`;
      document.getElementById('sendBtnOther').disabled = false;
      document.getElementById('sendBtnSpinnerOther').classList.add('d-none');
      document.getElementById('sendBtnTextOther').textContent = 'Send';
      return;
    }
    if ((currentUserData.balance ?? 0) < amount) {
      document.getElementById('transferAlertOther').innerHTML = `<div class="alert alert-danger">Insufficient balance.</div>`;
      document.getElementById('sendBtnOther').disabled = false;
      document.getElementById('sendBtnSpinnerOther').classList.add('d-none');
      document.getElementById('sendBtnTextOther').textContent = 'Send';
      return;
    }

    // Prompt for pin
    pendingTransfer = {
      recipientAccount,
      bankName,
      amount,
      isOtherBank: true
    };
    document.getElementById('transactionPinInput').value = "";
    document.getElementById('transactionPinError').textContent = "";
    setTimeout(() => transactionPinModal.show(), 300);

    // Reset button UI
    document.getElementById('sendBtnOther').disabled = false;
    document.getElementById('sendBtnSpinnerOther').classList.add('d-none');
    document.getElementById('sendBtnTextOther').textContent = 'Send';
  });

  // Update pin modal handler for Other Bank
  document.getElementById('submitTransactionPinBtn').onclick = async function() {
    const pin = document.getElementById('transactionPinInput').value.trim();
    if (!/^\d{4,6}$/.test(pin)) {
      document.getElementById('transactionPinError').textContent = "Invalid pin format.";
      return;
    }
    try {
      const user = auth.currentUser;
      if (!user) return;
      const userDoc = await db.collection('users').doc(user.uid).get();
      const userData = userDoc.data() || {};
      if (userData.transactionPin !== pin) {
        document.getElementById('transactionPinError').textContent = "Incorrect pin.";
        return;
      }
      transactionPinModal.hide();
      if (pendingTransfer.isOtherBank) {
        // No description modal for other bank, process directly
        setTimeout(() => processOtherBankTransfer(), 300);
      } else {
        setTimeout(() => descriptionModal.show(), 300);
      }
    } catch (err) {
      document.getElementById('transactionPinError').textContent = "Error verifying pin.";
    }
  };

  // Process Other Bank Transfer
  async function processOtherBankTransfer() {
    try {
      const user = auth.currentUser;
      if (!user || !currentUserData) return;

      // Prepare transaction object
      const transactionObj = {
        amount: pendingTransfer.amount,
        type: "send",
        description: `Sent to ${pendingTransfer.recipientAccount} at ${pendingTransfer.bankName}`,
        status: "processing",
        date: new Date().toISOString()
      };

      // Deduct sender's balance
      await db.collection('users').doc(user.uid).update({
        balance: firebase.firestore.FieldValue.increment(-pendingTransfer.amount)
      });

      // Save transaction centrally and reference only in sender
      await saveCentralTransaction(
        transactionObj,
        user.uid,
        null // No receiverId for other banks
      );

      // Update UI
      currentUserData.balance = (currentUserData.balance ?? 0) - pendingTransfer.amount;
      document.getElementById('user-balance').textContent = `$ ${currentUserData.balance}`;
      document.getElementById('transferFormOther').reset();

      transferSuccessModal.show();
    } catch (err) {
      alert("Failed to process transfer. Try again.");
    }
  }

  // Save transaction in central transfers collection
  async function saveCentralTransaction(transactionObj, senderId, receiverId) {
    // 1. Save transaction in transfers/transactions array
    const transfersDocRef = db.collection('transfers').doc('transactions');
    let transactionId = Math.floor(10000000000 + Math.random() * 90000000000).toString();
    transactionObj.id = transactionId;
    transactionObj.senderId = senderId;
    if (receiverId) transactionObj.receiverId = receiverId;

    await transfersDocRef.set({
      transactions: firebase.firestore.FieldValue.arrayUnion(transactionObj)
    }, { merge: true });

    // 2. Add transactionId to sender's transactionHistory
    await db.collection('users').doc(senderId).update({
      transactionHistory: firebase.firestore.FieldValue.arrayUnion(transactionId)
    });

    // 3. If receiver is a Geex user, add transactionId to their transactionHistory
    if (receiverId) {
      await db.collection('users').doc(receiverId).update({
        transactionHistory: firebase.firestore.FieldValue.arrayUnion(transactionId)
      });
    }

    return transactionId;
  }

  // Handle pin creation
  document.getElementById('savePinBtn').onclick = async function() {
    const pin = document.getElementById('newPinInput').value.trim();
    const confirmPin = document.getElementById('confirmNewPinInput').value.trim();
    if (!/^\d{4,6}$/.test(pin)) {
      document.getElementById('createPinError').textContent = "Pin must be 4-6 digits.";
      return;
    }
    if (pin !== confirmPin) {
      document.getElementById('createPinError').textContent = "Pins do not match.";
      return;
    }
    try {
      const user = auth.currentUser;
      if (!user) return;
      await db.collection('users').doc(user.uid).update({ transactionPin: pin });
      createPinModal.hide();
      setTimeout(() => descriptionModal.show(), 300);
    } catch (err) {
      document.getElementById('createPinError').textContent = "Failed to save pin.";
    }
  };

  // Handle pin entry
  document.getElementById('submitTransactionPinBtn').onclick = async function() {
    const pin = document.getElementById('transactionPinInput').value.trim();
    if (!/^\d{4,6}$/.test(pin)) {
      document.getElementById('transactionPinError').textContent = "Invalid pin format.";
      return;
    }
    try {
      const user = auth.currentUser;
      if (!user) return;
      const userDoc = await db.collection('users').doc(user.uid).get();
      const userData = userDoc.data() || {};
      if (userData.transactionPin !== pin) {
        document.getElementById('transactionPinError').textContent = "Incorrect pin.";
        return;
      }
      transactionPinModal.hide();
      setTimeout(() => descriptionModal.show(), 300);
    } catch (err) {
      document.getElementById('transactionPinError').textContent = "Error verifying pin.";
    }
  };

  // Handle description modal
  document.getElementById('saveDescriptionBtn').onclick = function() {
    pendingDescription = document.getElementById('transactionDescriptionInput').value.trim();
    descriptionModal.hide();
    setTimeout(() => processTransfer(), 300);
  };
  document.getElementById('skipDescriptionBtn').onclick = function() {
    pendingDescription = "";
    descriptionModal.hide();
    setTimeout(() => processTransfer(), 300);
  };

  // Main transfer processing function
  async function processTransfer() {
    try {
      const user = auth.currentUser;
      if (!user || !currentUserData) return;

      // Prepare transaction object (no id here)
      const transactionObj = {
        amount: pendingTransfer.amount,
        type: "send",
        description: pendingDescription || `Sent to ${pendingTransfer.recipientFullName} (${pendingTransfer.recipientAccount})`,
        status: "processing",
        date: new Date().toISOString()
      };

      // Deduct sender's balance
      await db.collection('users').doc(user.uid).update({
        balance: firebase.firestore.FieldValue.increment(-pendingTransfer.amount)
      });

      // Save transaction centrally and reference in both users
      await saveCentralTransaction(
        transactionObj,
        user.uid,
        pendingTransfer.recipientDocId // receiverId
      );

      // Update UI
      currentUserData.balance = (currentUserData.balance ?? 0) - pendingTransfer.amount;
      document.getElementById('user-balance').textContent = `$ ${currentUserData.balance}`;
      document.getElementById('transferFormGeex').reset();

      transferSuccessModal.show();
    } catch (err) {
      alert("Failed to process transfer. Try again.");
    }
  }
   // Sidebar toggle for mobile
    const sidebar = document.getElementById('sidebarNav');
    const sidebarToggle = document.getElementById('sidebarToggle');
    
    if (sidebarToggle) {
      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('show');
      });
    }

    document.addEventListener('click', function(e) {
      if (window.innerWidth < 992 && sidebar.classList.contains('show')) {
        if (!sidebar.contains(e.target) && !sidebarToggle?.contains(e.target)) {
          sidebar.classList.remove('show');
        }
      }
    });
</script>
</body>
</html>